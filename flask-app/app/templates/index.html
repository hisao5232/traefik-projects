{% extends "layout.html" %}
{% block title %}Todo App{% endblock %}
{% block content %}
<div class="bg-white p-4 rounded shadow-sm">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0 fade-in">ğŸ“ Todo List</h2>
        <form action="/logout" method="get">
            <button type="submit" class="btn btn-outline-danger btn-sm">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </form>
    </div>

    <!-- æ–°è¦ã‚¿ã‚¹ã‚¯ãƒ•ã‚©ãƒ¼ãƒ  -->
    <form id="todo-form" class="mb-4">
        <div class="mb-3">
            <input type="text" id="task" class="form-control" placeholder="ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›" required>
        </div>
        <div class="mb-3">
            <textarea id="description" class="form-control" placeholder="è©³ç´°ã‚’å…¥åŠ›"></textarea>
        </div>
        <div class="mb-3">
            <input type="date" id="due_date" class="form-control">
        </div>
        <button type="submit" class="btn btn-primary w-100">è¿½åŠ </button>
    </form>

    <ul id="todo-list" class="list-unstyled"></ul>
</div>

<script>
const form = document.getElementById("todo-form");
const taskInput = document.getElementById("task");
const descriptionInput = document.getElementById("description");
const dueDateInput = document.getElementById("due_date");
const todoList = document.getElementById("todo-list");

// ã‚¿ã‚¹ã‚¯å–å¾—
async function fetchTodos() {
    const res = await fetch("/todos", { credentials: "same-origin" });
    if (!res.ok) {
        const err = await res.json();
        alert(err.error || "ã‚¿ã‚¹ã‚¯å–å¾—ã«å¤±æ•—");
        return;
    }
    const todos = await res.json();
    todoList.innerHTML = "";

    todos.forEach(todo => {
        const li = document.createElement("li");
        li.className = "todo-item";
        if (todo.done) li.classList.add("done");

        li.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <strong>${todo.task}</strong><br>
                    <small>${todo.description || ""}</small><br>
                    <small class="text-muted">æœŸé™: ${todo.due_date || "ãªã—"}</small>
                </div>
                <div>
                    <button class="btn btn-sm btn-success toggle-done">${todo.done ? "æœªå®Œäº†" : "å®Œäº†"}</button>
                    <button class="btn btn-sm btn-warning edit">ç·¨é›†</button>
                    <button class="btn btn-sm btn-danger delete">å‰Šé™¤</button>
                </div>
            </div>
        `;

        // å®Œäº†åˆ‡æ›¿
        li.querySelector(".toggle-done").onclick = async () => {
            await fetch(`/todos/${todo.id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                credentials: "same-origin",
                body: JSON.stringify({
                    task: todo.task,
                    description: todo.description,
                    due_date: todo.due_date,
                    done: !todo.done
                })
            });
            fetchTodos();
        };

        // å‰Šé™¤
        li.querySelector(".delete").onclick = async () => {
            await fetch(`/todos/${todo.id}`, {
                method: "DELETE",
                credentials: "same-origin"
            });
            fetchTodos();
        };

        // ç·¨é›†
        li.querySelector(".edit").onclick = () => {
            li.innerHTML = `
                <input type="text" class="form-control edit-input edit-task mb-2" value="${todo.task}" required>
                <textarea class="form-control edit-input edit-description mb-2">${todo.description || ""}</textarea>
                <input type="date" class="form-control edit-input edit-due mb-2" value="${todo.due_date || ""}">
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-primary save">ä¿å­˜</button>
                    <button class="btn btn-sm btn-secondary cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            `;

            // ä¿å­˜
            li.querySelector(".save").onclick = async () => {
                const newTask = li.querySelector(".edit-task").value;
                const newDesc = li.querySelector(".edit-description").value;
                const newDue = li.querySelector(".edit-due").value || null;

                await fetch(`/todos/${todo.id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    credentials: "same-origin",
                    body: JSON.stringify({
                        task: newTask,
                        description: newDesc,
                        due_date: newDue,
                        done: todo.done
                    })
                });
                fetchTodos();
            };

            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            li.querySelector(".cancel").onclick = () => fetchTodos();
        };

        todoList.appendChild(li);
    });
}

// æ–°è¦ã‚¿ã‚¹ã‚¯è¿½åŠ 
form.onsubmit = async (e) => {
    e.preventDefault();
    await fetch("/todos", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify({
            task: taskInput.value,
            description: descriptionInput.value,
            due_date: dueDateInput.value || null
        })
    });
    taskInput.value = "";
    descriptionInput.value = "";
    dueDateInput.value = "";
    fetchTodos();
};

fetchTodos();
</script>
{% endblock %}
